<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paris Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            border: none;
            border-radius: 0;
            box-shadow: none;
            position: relative;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        select {
            padding: 10px 15px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 160px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        select:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        select:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .map-controls {
                top: 20px;
                right: 20px;
            }
            
            select {
                font-size: 16px;
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <div id="map">
        <div class="map-controls">
            <select id="daySelector">
                <option value="">Select a day...</option>
                <option value="day1">Wednesday, Aug 27</option>
                <option value="day2">Thursday, Aug 28</option>
                <option value="day3">Friday, Aug 29</option>
                <option value="day4">Saturday, Aug 30</option>
                <option value="day5">Sunday, Aug 31</option>
                <option value="day6">Monday, Sep 1</option>
                <option value="day7">Tuesday, Sep 2</option>
                <option value="day8">Wednesday, Sep 3</option>
            </select>
        </div>
    </div>

    <script>
        // Initialize the map centered on Paris
        const map = L.map('map').setView([48.8566, 2.3522], 12);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Store current markers
        let currentMarkers = [];

        // Itinerary data with locations and approximate coordinates
        const itinerary = {
            day1: [
                {
                    name: "Hôtel Charles V",
                    coords: [48.8545, 2.3614],
                    text: "19:00 Hotel arrival and check-in - 20 Rue Saint-Paul, 75004 Paris (Le Marais)"
                },
                {
                    name: "Les Fous de l'Île",
                    coords: [48.8519, 2.3559],
                    text: "21:00 Dinner Les Fous de l'Île - 33 Rue des Deux Ponts Paris (open until 00:00)"
                }
            ],
            day2: [
                {
                    name: "Musée d'Orsay",
                    coords: [48.8599, 2.3266],
                    text: "11:00 – Musee d'Orsay 2-3 hours"
                },
                {
                    name: "Records - Rue des Écoles",
                    coords: [48.8483, 2.3472],
                    text: "13:30 - Records - Rue des Écoles"
                },
                {
                    name: "Shakespeare & Company",
                    coords: [48.8522, 2.3472],
                    text: "14:30 – Shakespeare & Company, 37 Rue de la Bûcherie, 75005 (10:00-20:00)"
                },
                {
                    name: "Latin Quarter exploration",
                    coords: [48.8434, 2.3488],
                    text: "15:30 – Latin Quarter exploration - Rue Mouffetard + Place de la Contrescarpe"
                },
                {
                    name: "Boulevard Saint-Germain",
                    coords: [48.8539, 2.3356],
                    text: "16:30 – Walk along Boulevard Saint-Germain"
                },

                {
                    name: "Ha Noi Restaurant",
                    coords: [48.8566, 2.3410],
                    text: "19:00 – Dinner: Ha Noi - 72 Quai des Orfèvres, 75001 Paris"
                }
            ],
            day3: [
                {
                    name: "Fondation Louis Vuitton",
                    coords: [48.8769, 2.2646],
                    text: "10:30 – Fondation Louis Vuitton – David Hockney, 8 Av. du Mahatma Gandhi, 75116 (10:00-20:00, Friday until 23:00)"
                },
                {
                    name: "Passage des Panoramas",
                    coords: [48.8715, 2.3403],
                    text: "14:00 – Passage des Panoramas (2nd arr.) → Passage Jouffroy and Passage Verdeau (9th arr.)"
                },
                {
                    name: "Passage Vivienne",
                    coords: [48.8669, 2.3386],
                    text: "15:00 – Passage Vivienne (2nd arr.) - close to other passages"
                },
                {
                    name: "Rue Montorgueil",
                    coords: [48.8644, 2.3467],
                    text: "15:30 – Rue Montorgueil + Episode Vintage, 12-16 Rue Tiquetonne, 75002"
                },
                {
                    name: "Stohrer Patisserie",
                    coords: [48.8644, 2.3467],
                    text: "16:30 – patisserie - Stohrer patisserie 51 Rue Montorgueil, 75002"
                },
                {
                    name: "Au Pied de Fouet",
                    coords: [48.8518, 2.3186],
                    text: "19:30 - Dinner Au Pied de Fouet 45 Rue de Babylone, 75007 Paris, France"
                }
            ],
            day4: [
                {
                    name: "Marché aux Puces de Vanves",
                    coords: [48.8283, 2.2945],
                    text: "09:30 – Marché aux Puces de Vanves, Av. Georges Lafenestre, 75014 (Sat-Sun 07:00-14:00)"
                },
                {
                    name: "Marche du livre + Park George Brassens",
                    coords: [48.8358, 2.3014],
                    text: "12:00 - Marche du livre (until 18:00) + Park George Brassens"
                },
                {
                    name: "Mama Restaurant Paris West",
                    coords: [48.8358, 2.3014],
                    text: "13:00 - restaurant (Mama Restaurant Paris West)"
                },
                {
                    name: "Thanx God I'm a V.I.P.",
                    coords: [48.8705, 2.3642],
                    text: "16:00 - Vintage Clothing Thanx God I'm a V.I.P., 12 Rue de Lancry, 75010 (Tue-Sat 11:00-19:30, closed Sun)"
                },
                {
                    name: "Canal Saint-Martin",
                    coords: [48.8705, 2.3642],
                    text: "16:30 – Canal Saint-Martin"
                },
                {
                    name: "House of 3 Brothers",
                    coords: [48.8705, 2.3642],
                    text: "17:00 - Patisserie House of 3 Brothers, 57 Rue de Lancry, 75010"
                },
                {
                    name: "Galerie Mémoire de l'Avenir",
                    coords: [48.8735, 2.3836],
                    text: "18:00 – Galerie Mémoire de l'Avenir, 45/47 Rue Ramponeau, 75020 (Wed-Sat 11:00-19:00)"
                },
                {
                    name: "DINNER PLACEHOLDER",
                    coords: [48.8705, 2.3642],
                    text: "19:30 – DINNER PLACEHOLDER"
                }
            ],
            day5: [
                {
                    name: "Odette Café",
                    coords: [48.8508, 2.3472],
                    text: "09:00 – Coffee at Odette, 77 Rue Galande, 75005 Paris"
                },
                {
                    name: "Rue de Furstemberg",
                    coords: [48.8558, 2.3339],
                    text: "10:00 – Rue de Furstemberg (charming small square)"
                },
                {
                    name: "Jardin du Luxembourg",
                    coords: [48.8462, 2.3372],
                    text: "11:00 – Jardin du Luxembourg (75006, 07:30-20:00)"
                },
                {
                    name: "Musée de l'Orangerie",
                    coords: [48.8638, 2.3223],
                    text: "15:00 – Musée de l'Orangerie, Jardin des Tuileries, Place de la Concorde, 75001 (09:00-18:00)"
                },
                {
                    name: "Bouillon Julien",
                    coords: [48.8710, 2.3552],
                    text: "19:30 – Dinner Bouillon Julien 16 Rue du Faubourg Saint-Denis, 75010 Paris, France"
                }
            ],
            day6: [
                {
                    name: "La Palette",
                    coords: [48.8550, 2.3350],
                    text: "09:00 - La palette"
                },
                {
                    name: "Sacré-Cœur",
                    coords: [48.8867, 2.3431],
                    text: "10:30 – Sacré-Cœur, 35 Rue du Chevalier-de-la-Barre, 75018 (06:00-22:30)"
                },
                {
                    name: "Montmartre Square",
                    coords: [48.8867, 2.3431],
                    text: "11:00 - Montmartre square"
                },
                {
                    name: "Montmartre Record Shop",
                    coords: [48.8867, 2.3431],
                    text: "11:30 - Montmartre Record shop, 8 Rue Pierre Picard, 75018 (Tue-Sat 11:00-19:00, closed Sun)"
                },
                {
                    name: "Guerrisol",
                    coords: [48.8614, 2.3522],
                    text: "14:00 - Guerrisol 8 Bd de Sébastopol, 75004 Paris, France"
                },
                {
                    name: "Kilo Shop",
                    coords: [48.8588, 2.3580],
                    text: "14:15 – Kilo Shop, 69 Rue de la Verrerie, 75004 (11:00-20:00)"
                },
                {
                    name: "Free'P'Star",
                    coords: [48.8588, 2.3580],
                    text: "14:30 – Free'P'Star, 61 Rue de la Verrerie, 75004 (11:00-21:00)"
                },
                {
                    name: "DINNER PLACEHOLDER",
                    coords: [48.8588, 2.3580],
                    text: "19:30 – DINNER PLACEHOLDER"
                }
            ],
            day7: [
                {
                    name: "Restaurant Parcelles",
                    coords: [48.8630, 2.3614],
                    text: "12:30 – Restaurant Parcelles, 13 Rue Chapon, 75003 Paris (12:00-14:30, 19:30-22:30)"
                },
                {
                    name: "Place des Vosges",
                    coords: [48.8555, 2.3658],
                    text: "15:30 – Place des Vosges + Musée Carnavalet, 23 Rue de Sévigné, 75003 (10:00-18:00, closed Tue)"
                },
                {
                    name: "Record Shop Saint-Sabin",
                    coords: [48.8589, 2.3703],
                    text: "16:30 – Record shop, 11 Rue Saint-Sabin, 75011 (Tue-Sat 11:00-19:00, closed Sun)"
                },
                {
                    name: "Didier Ludot",
                    coords: [48.8669, 2.3386],
                    text: "18:30 – Didier Ludot (Palais Royal, 75001)"
                }
            ],
            day8: [
                {
                    name: "Le Peloton Café",
                    coords: [48.8545, 2.3614],
                    text: "09:00 – Coffee at Le Peloton Café, 17 Rue du Pont Louis-Philippe, 75004"
                },
                {
                    name: "Île Saint-Louis",
                    coords: [48.8518, 2.3559],
                    text: "10:00 – Walk around Île Saint-Louis"
                },
                {
                    name: "Marché aux Fleurs Reine-Elizabeth II",
                    coords: [48.8556, 2.3465],
                    text: "11:00 – Marché aux Fleurs Reine-Elizabeth II, Place Louis Lépine, 75004 (Tue-Sat 08:00-19:00)"
                }
            ]
        };

        // Create custom numbered icons - can handle multiple numbers
        function createNumberedIcon(numbers, color = '#ff6b6b') {
            const numbersText = Array.isArray(numbers) ? numbers.join(',') : numbers;
            const width = numbersText.length > 2 ? Math.max(25, numbersText.length * 8) : 25;
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color:${color};color:white;width:${width}px;height:25px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);">${numbersText}</div>`,
                iconSize: [width, 25],
                iconAnchor: [width/2, 12]
            });
        }

        // Determine if activity is morning or afternoon based on time in text
        function getActivityColor(text) {
            // Check for dinner entries first
            if (text.toLowerCase().includes('dinner')) {
                return '#000000'; // Black for dinner
            }
            
            // Look for time patterns like "09:00", "11:00", "14:00", etc.
            const timeMatch = text.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                const hour = parseInt(timeMatch[1]);
                if (hour < 12) {
                    return '#87CEEB'; // Light blue for morning
                } else if (hour < 19) {
                    return '#FF8C00'; // Orange for afternoon
                } else {
                    return '#000000'; // Black for evening (19+)
                }
            }
            // Default to orange if no time found (assume afternoon)
            return '#FF8C00';
        }

        // Clear current markers
        function clearMarkers() {
            currentMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            currentMarkers = [];
        }

        // Function to check if two coordinates are very close (within ~100m)
        function areCoordinatesClose(coord1, coord2, threshold = 0.001) {
            return Math.abs(coord1[0] - coord2[0]) < threshold && Math.abs(coord1[1] - coord2[1]) < threshold;
        }

        // Show locations for selected day
        function showDayLocations(day) {
            clearMarkers();
            
            if (!day || !itinerary[day]) {
                return;
            }

            const locations = itinerary[day];
            
            // Group locations by proximity
            const groups = [];
            locations.forEach((location, index) => {
                const locationWithIndex = { ...location, originalIndex: index + 1 };
                
                // Find existing group with close coordinates
                let addedToGroup = false;
                for (let group of groups) {
                    if (areCoordinatesClose(location.coords, group.coords)) {
                        group.locations.push(locationWithIndex);
                        addedToGroup = true;
                        break;
                    }
                }
                
                // If no close group found, create new group
                if (!addedToGroup) {
                    groups.push({
                        coords: location.coords,
                        locations: [locationWithIndex]
                    });
                }
            });
            
            // Create markers for each group
            groups.forEach(group => {
                // Get all colors for activities in this group
                const colors = group.locations.map(loc => getActivityColor(loc.text));
                // Use the most common color, or the first one if all different
                const color = colors[0];
                
                // Get all numbers for this group
                const numbers = group.locations.map(loc => loc.originalIndex);
                
                // Create marker with combined numbers
                const marker = L.marker(group.coords, {
                    icon: createNumberedIcon(numbers, color)
                }).addTo(map);
                
                // Create combined popup content
                let popupContent = '';
                group.locations.forEach((loc, idx) => {
                    if (idx > 0) popupContent += '<hr style="margin: 8px 0;">';
                    popupContent += `<b>${loc.originalIndex}. ${loc.name}</b><br>${loc.text}`;
                });
                
                marker.bindPopup(popupContent);
                currentMarkers.push(marker);
            });

            // Fit map to show all markers
            if (currentMarkers.length > 0) {
                const group = new L.featureGroup(currentMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Event listener for day selector
        document.getElementById('daySelector').addEventListener('change', function(e) {
            showDayLocations(e.target.value);
        });

        // Initial hotel marker
        const hotelMarker = L.marker([48.8545, 2.3614], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        hotelMarker.bindPopup('<b>🏨 Hôtel Charles V</b><br>Your hotel in Le Marais<br>20 Rue Saint-Paul, 75004 Paris');
    </script>
</body>
</html>
